<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskWise v2.4</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* LIGHT THEME */
      --primary-grad: linear-gradient(135deg, #b1121f 0%, #ff4d5e 100%);
      --bg-color: #f0f2f5;
      
      --glass: rgba(255, 255, 255, 0.6);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
      
      --text: #1d1d1f;
      --text-secondary: #666;
      --card-bg: rgba(255, 255, 255, 0.5);
      --input-bg: rgba(255, 255, 255, 0.7);
      
      --success: #00a854;
      --warning: #faad14;
      --danger: #f5222d;
    }

    body.dark-mode {
      /* DARK THEME */
      --primary-grad: linear-gradient(135deg, #d3202f 0%, #ff7875 100%);
      --bg-color: #0f0f12;
      
      --glass: rgba(20, 20, 20, 0.7);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      
      --text: #e0e0e0;
      --text-secondary: #a0a0a0;
      --card-bg: rgba(255, 255, 255, 0.03);
      --input-bg: rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      font-family: "Montserrat", sans-serif;
      transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                  color 0.3s, 
                  border-color 0.3s, 
                  box-shadow 0.3s;
    }

    body {
      margin: 0;
      background-color: var(--bg-color);
      min-height: 100vh;
      color: var(--text);
      padding-top: 20px;
      overflow-x: hidden;
      position: relative;
    }

    /* BACKGROUND ORBS ANIMATION */
    .bg-orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(80px);
      z-index: -1;
      opacity: 0.6;
      animation: float 20s infinite ease-in-out;
    }
    
    .orb-1 {
      top: -10%;
      left: -10%;
      width: 50vw;
      height: 50vw;
      background: radial-gradient(circle, #ff9a9e 0%, transparent 70%);
      animation-delay: 0s;
    }
    
    .orb-2 {
      bottom: -10%;
      right: -10%;
      width: 60vw;
      height: 60vw;
      background: radial-gradient(circle, #a18cd1 0%, transparent 70%);
      animation-delay: -10s;
    }

    body.dark-mode .orb-1 { background: radial-gradient(circle, #4a192c 0%, transparent 70%); opacity: 0.4; }
    body.dark-mode .orb-2 { background: radial-gradient(circle, #1a1a3a 0%, transparent 70%); opacity: 0.4; }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(30px, 50px); }
    }

    /* CUSTOM SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
    body.dark-mode ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

    /* CONFETTI CANVAS */
    #confetti-canvas {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 9999;
    }

    /* --- NAVBAR --- */
    .topnav {
      position: sticky;
      top: 20px;
      height: 72px;
      background: var(--glass);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      border-radius: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      margin: 0 20px;
      z-index: 1000;
    }

    @media (min-width: 1140px) {
      .topnav { margin: 0 auto; max-width: 1100px; }
    }

    .left, .center, .right { display: flex; align-items: center; gap: 14px; }

    /* LOGO */
    .logo-container { display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none; }
    .logo-icon { filter: drop-shadow(0 4px 6px rgba(177, 18, 31, 0.25)); transition: transform 0.3s; }
    .logo-container:hover .logo-icon { transform: scale(1.1) rotate(-5deg); }
    .brand { font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; color: var(--text); }
    .brand::after { content: '.'; color: #ff4d5e; font-size: 1.6rem; margin-left: 1px; }

    /* THEME TOGGLE */
    .theme-toggle {
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      color: var(--text);
      width: 40px; height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .theme-toggle:hover { transform: rotate(15deg) scale(1.1); background: var(--glass); }

    /* SEARCH */
    .search {
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid var(--glass-border);
      outline: none;
      font-size: 0.9rem;
      background: var(--input-bg);
      color: var(--text);
      width: 200px;
      transition: all 0.3s;
    }
    .search:focus {
      border-color: #ff4d5e;
      width: 240px;
      box-shadow: 0 0 0 3px rgba(255, 77, 94, 0.15);
    }

    /* NAV BUTTONS */
    .center button {
      background: transparent;
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-secondary);
      position: relative;
      overflow: hidden;
    }
    .center button:hover { color: var(--text); background: rgba(125,125,125,0.1); }
    .center button.active {
      color: #ff4d5e;
      background: rgba(255, 77, 94, 0.08);
    }

    /* --- LAYOUT & GLASS --- */
    .wrapper { padding: 32px; max-width: 1100px; margin: auto; position: relative; }
    .page { display: none; opacity: 0; transition: opacity 0.3s; }
    .page.active { display: block; opacity: 1; animation: fadeIn 0.4s ease-out; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .glass {
      background: var(--glass);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: var(--glass-shadow);
    }

    /* --- HERO & DASHBOARD --- */
    .hero { padding: 50px 60px; }
    .hero-flex { display: flex; justify-content: space-between; align-items: center; gap: 40px; }
    .hero h1 { font-size: 3rem; margin: 0 0 16px 0; line-height: 1.1; letter-spacing: -1px; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .hero p { font-size: 1.1rem; line-height: 1.6; opacity: 0.9; margin-bottom: 24px; font-weight: 500; }
    .hero-illustration { max-width: 300px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); }
    
    .stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-top: 50px; }
    .stat-card {
      background: var(--card-bg); padding: 24px; border-radius: 20px; text-align: center;
      border: 1px solid var(--glass-border); position: relative; overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--text); display: block; margin-bottom: 5px; }
    .stat-label { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1.5px; }

    /* --- TASK INPUTS --- */
    .card { padding: 32px; margin-bottom: 32px; }
    .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full-width { grid-column: span 2; }

    label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; margin-top: 16px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    label:first-of-type { margin-top: 0; }

    input, select {
      width: 100%; padding: 14px; border-radius: 12px;
      border: 1px solid var(--glass-border); background: var(--input-bg);
      font-size: 0.95rem; color: var(--text); outline: none;
    }
    input:focus, select:focus { border-color: #ff4d5e; box-shadow: 0 0 0 3px rgba(255, 77, 94, 0.1); background: var(--glass); }

    .btn-group { display: flex; gap: 12px; margin-top: 24px; }

    button.primary-btn {
      flex: 1; padding: 14px; border-radius: 12px; border: none;
      background: var(--primary-grad); color: #fff; font-weight: 700; font-size: 1rem;
      cursor: pointer; box-shadow: 0 4px 15px rgba(255, 77, 94, 0.3);
    }
    button.primary-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 77, 94, 0.4); }
    button.primary-btn:active { transform: scale(0.98); }

    button.secondary-btn {
      padding: 12px 24px; border-radius: 12px; border: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.05); color: var(--text); font-weight: 600; cursor: pointer;
    }
    button.secondary-btn:hover { background: rgba(0,0,0,0.05); }

    /* --- KANBAN BOARD --- */
    .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-top: 24px; padding-bottom: 20px; }
    
    .kanban-column {
      background: rgba(255,255,255,0.05); 
      border-radius: 20px; padding: 16px;
      border: 1px solid var(--glass-border);
      min-height: 400px; display: flex; flex-direction: column;
    }
    body.dark-mode .kanban-column { background: rgba(0,0,0,0.2); }

    .kanban-header {
      font-weight: 800; text-transform: uppercase; color: var(--text-secondary);
      font-size: 0.85rem; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;
      letter-spacing: 1px; padding: 0 4px;
    }
    
    .count-badge { background: var(--text-secondary); color: var(--bg-color); font-size: 0.75rem; padding: 2px 10px; border-radius: 99px; font-weight: 700; }

    /* TASK CARD */
    .kanban-task {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      padding: 18px; border-radius: 16px; margin-bottom: 16px;
      border: 1px solid var(--glass-border);
      cursor: grab;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .kanban-task:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 12px 24px rgba(0,0,0,0.1); border-color: rgba(255, 77, 94, 0.3); z-index: 10; }
    .kanban-task:active { cursor: grabbing; transform: scale(0.98); }

    .task-title { font-weight: 700; font-size: 1rem; margin-bottom: 8px; color: var(--text); line-height: 1.4; }
    
    .task-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); }
    
    .priority-badge {
      font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
      padding: 4px 10px; border-radius: 6px; letter-spacing: 0.5px;
    }
    .badge-high { background: rgba(245, 34, 45, 0.1); color: var(--danger); border: 1px solid rgba(245, 34, 45, 0.2); }
    .badge-medium { background: rgba(250, 173, 20, 0.1); color: var(--warning); border: 1px solid rgba(250, 173, 20, 0.2); }
    .badge-low { background: rgba(0, 168, 84, 0.1); color: var(--success); border: 1px solid rgba(0, 168, 84, 0.2); }

    .task-assignee { font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; font-weight: 600; }
    .mini-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background: #fff; border: 1px solid var(--glass-border); }

    .deadline-indicator {
      position: absolute; top: 18px; right: 18px;
      width: 8px; height: 8px; border-radius: 50%;
    }
    .dot-overdue { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
    .dot-today { background: var(--warning); box-shadow: 0 0 8px var(--warning); }
    
    .kanban-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; text-align: center; color: var(--text); min-height: 150px; }
    .kanban-empty svg { width: 48px; height: 48px; margin-bottom: 10px; fill: var(--text); opacity: 0.5; }

    /* --- MEMBERS --- */
    .members-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 24px; }
    .member-card { 
      padding: 24px; text-align: center; cursor: pointer; border: 1px solid var(--glass-border); background: var(--card-bg);
      border-radius: 20px; transition: all 0.3s; position: relative; overflow: hidden;
    }
    .member-card:hover { transform: translateY(-5px); border-color: #ff4d5e; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    
    .member-avatar-container { position: relative; width: 80px; height: 80px; margin: 0 auto 16px; }
    .member-avatar { width: 100%; height: 100%; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 8px 20px rgba(0,0,0,0.15); object-fit: cover; background: white; }
    .upload-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); border-radius: 50%; display: flex;
      align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
      color: white; font-size: 1.5rem;
    }
    .member-avatar-container:hover .upload-overlay { opacity: 1; }
    
    .member-filter-active { background: linear-gradient(135deg, #b1121f, #ff4d5e); color: white !important; border: none; }
    .member-filter-active * { color: white !important; }

    /* --- TOASTS --- */
    #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
    .toast {
      background: var(--glass); backdrop-filter: blur(16px);
      padding: 16px 24px; border-radius: 14px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      border: 1px solid var(--glass-border); border-left: 5px solid #333;
      color: var(--text); min-width: 300px; font-weight: 600; font-size: 0.95rem;
      animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    @keyframes toastIn { from { transform: translateX(100%) scale(0.9); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      .kanban-board { grid-template-columns: 1fr; }
      .kanban-column { min-height: auto; }
      .input-grid { grid-template-columns: 1fr; }
      .full-width { grid-column: span 1; }
    }
    @media (max-width: 768px) {
      .hero-flex { flex-direction: column-reverse; text-align: center; }
      .stats-container { grid-template-columns: 1fr; }
      .topnav { padding: 0 16px; margin: 0 12px; top: 10px; }
      .center button span { display: none; }
      .center { gap: 4px; }
      .hero h1 { font-size: 2.2rem; }
    }
  </style>
</head>
<body class="">

<!-- HIDDEN FILE INPUT FOR AVATAR UPLOAD -->
<input type="file" id="avatarUpload" style="display:none" accept="image/*">

<!-- BACKGROUND ORBS -->
<div class="bg-orb orb-1"></div>
<div class="bg-orb orb-2"></div>

<canvas id="confetti-canvas"></canvas>
<div id="toast-container"></div>

<!-- NAVBAR -->
<div class="topnav">
  <div class="left">
    <div class="logo-container" onclick="showPage('home')">
      <div class="logo-icon">
        <svg width="36" height="36" viewBox="0 0 34 34" fill="none">
          <rect width="34" height="34" rx="10" fill="url(#logo_grad)"/>
          <path d="M9.5 17L14 21.5L24.5 11" stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
          <defs>
            <linearGradient id="logo_grad" x1="0" y1="0" x2="34" y2="34" gradientUnits="userSpaceOnUse">
              <stop stop-color="#b1121f"/>
              <stop offset="1" stop-color="#ff4d5e"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <span class="brand">TaskWise</span>
    </div>
  </div>

  <div class="center">
    <button class="active" onclick="showPage('home')">Home</button>
    <button onclick="showPage('tasks')">Tasks</button>
    <button onclick="showPage('members')">Members</button>
    <button onclick="showPage('about')">About</button>
  </div>

  <div class="right">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
      <span id="theme-icon">ðŸŒ™</span>
    </button>
    <input class="search" id="searchInput" placeholder="Search tasks & members..." onkeyup="handleSearch()">
  </div>
</div>

<div class="wrapper">

  <!-- HOME -->
  <section id="home" class="page active">
    <div class="glass hero">
      <div class="hero-flex">
        <div class="hero-text">
          <h1>Organize your team<br>with modern simplicity</h1>
          <p>TaskWise gives you clarity on who is doing what, when it's due, and what's next.</p>
          <button class="primary-btn" onclick="showPage('tasks')" style="width: auto; padding: 14px 32px;">Launch Dashboard</button>
        </div>
        <img src="https://illustrations.popsy.co/amber/work-from-home.svg" class="hero-illustration" alt="Team Work">
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <span class="stat-number" id="stat-total">0</span>
          <span class="stat-label">Total Tasks</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="stat-pending">0</span>
          <span class="stat-label">Pending</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="stat-members">0</span>
          <span class="stat-label">Team Members</span>
        </div>
      </div>
    </div>
  </section>

  <!-- TASKS -->
  <section id="tasks" class="page">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
      <h2 style="margin:0; font-size: 2rem;">Task Board</h2>
      <button class="secondary-btn" id="clearFilterBtn" style="display:none; color: #ff4d5e; border-color: #ff4d5e;" onclick="clearMemberFilter()">Clear Filter âœ•</button>
    </div>
    
    <!-- TASK FORM -->
    <div class="glass card">
      <div class="input-grid">
        <div class="full-width">
          <label>Task Title</label>
          <input id="taskName" placeholder="What needs to be done?">
        </div>
        
        <div>
          <label>Due Date</label>
          <input id="taskDeadline" type="date">
        </div>
        
        <div>
          <label>Priority</label>
          <select id="taskPriority">
            <option value="Low">Low</option>
            <option value="Medium" selected>Medium</option>
            <option value="High">High</option>
          </select>
        </div>

        <div>
          <label>Assignee</label>
          <select id="taskMember"></select>
        </div>
        
        <div>
          <label>Status</label>
          <select id="taskStatus">
            <option value="Not Started">To Do</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Done</option>
          </select>
        </div>
      </div>

      <div class="btn-group">
        <button class="secondary-btn" id="cancelEditBtn" style="display:none" onclick="cancelEdit()">Cancel</button>
        <button class="primary-btn" id="saveTaskBtn" onclick="saveTask()">Create Task</button>
      </div>
    </div>

    <!-- KANBAN BOARD -->
    <div class="kanban-board">
      
      <!-- TODO -->
      <div class="kanban-column" id="col-todo" ondrop="drop(event, 'Not Started')" ondragover="allowDrop(event)">
        <div class="kanban-header">To Do <span class="count-badge" id="count-todo">0</span></div>
        <div class="task-list" id="list-todo"></div>
      </div>

      <!-- PROGRESS -->
      <div class="kanban-column" id="col-progress" ondrop="drop(event, 'In Progress')" ondragover="allowDrop(event)">
        <div class="kanban-header">In Progress <span class="count-badge" id="count-progress">0</span></div>
        <div class="task-list" id="list-progress"></div>
      </div>

      <!-- DONE -->
      <div class="kanban-column" id="col-done" ondrop="drop(event, 'Completed')" ondragover="allowDrop(event)">
        <div class="kanban-header">Done <span class="count-badge" id="count-done">0</span></div>
        <div class="task-list" id="list-done"></div>
      </div>

    </div>
  </section>

  <!-- MEMBERS -->
  <section id="members" class="page">
    <h2 style="font-size: 2rem; margin-bottom: 10px;">Team Members</h2>
    <p style="opacity: 0.7; margin-bottom: 30px;">Hover an avatar to upload a photo. Click the card to filter tasks.</p>
    
    <div class="glass card">
      <div class="input-grid">
        <div class="full-width">
          <label>Name</label>
          <input id="memberName" placeholder="e.g. Sarah Smith">
        </div>
        <div class="full-width">
          <label>Role</label>
          <input id="memberRole" placeholder="e.g. Product Designer">
        </div>
      </div>
      <div class="btn-group">
        <button class="primary-btn" onclick="addMember()">Add Member</button>
      </div>
    </div>
    
    <div class="members-grid" id="memberCards"></div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="page">
    <div class="glass hero">
      <h2>About TaskWise</h2>
      <p>A beautiful, frontend-only task management tool.</p>
      <p style="font-size: 0.9rem; opacity: 0.7;">Version 2.4 â€¢ Generic Avatar Fallback</p>
      
      <div style="margin-top: 40px; display: flex; flex-direction: column; gap: 15px;">
        <h3 style="margin:0;">Data Management</h3>
        <p style="font-size: 0.8rem; opacity: 0.8; margin:0;">Backup your local data to a JSON file.</p>
        <div style="display:flex; gap:12px; margin-top: 10px;">
          <button class="secondary-btn" onclick="exportData()">â¬‡ Export Data</button>
          <button class="secondary-btn" onclick="document.getElementById('importFile').click()">â¬† Import Data</button>
          <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>
        
        <h3 style="margin-top: 30px; margin-bottom: 0;">Danger Zone</h3>
        <button class="primary-btn" onclick="clearData()" style="background:#333; box-shadow:none; width:auto;">Factory Reset</button>
      </div>
    </div>
  </section>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  
  // --- STATE ---
  const defaultMembers = [
    { name: "Jatin", role: "Admin", image: null },
    { name: "Aru", role: "Member", image: null }
  ];

  let members = JSON.parse(localStorage.getItem('tw_members')) || defaultMembers;
  let tasks = JSON.parse(localStorage.getItem('tw_tasks')) || [];
  let editingId = null;
  let activeMemberFilter = null;
  let memberToUploadFor = null; // Track which member we are uploading a photo for
  let isDarkMode = localStorage.getItem('tw_darkmode') === 'true';

  // --- THEME INIT ---
  if(isDarkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-icon').textContent = 'â˜€ï¸';
  }

  window.toggleTheme = () => {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode');
    document.getElementById('theme-icon').textContent = isDarkMode ? 'â˜€ï¸' : 'ðŸŒ™';
    localStorage.setItem('tw_darkmode', isDarkMode);
  };

  // --- ELEMENTS ---
  const pages = document.querySelectorAll(".page");
  const navButtons = document.querySelectorAll(".center button");
  const searchInput = document.getElementById("searchInput");
  const avatarUploadInput = document.getElementById("avatarUpload");

  const taskNameInput = document.getElementById("taskName");
  const taskDeadlineInput = document.getElementById("taskDeadline");
  const taskPrioritySelect = document.getElementById("taskPriority");
  const taskMemberSelect = document.getElementById("taskMember");
  const taskStatusSelect = document.getElementById("taskStatus");
  const saveTaskBtn = document.getElementById("saveTaskBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");

  // --- NAVIGATION ---
  window.showPage = (id) => {
    pages.forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    navButtons.forEach(b => b.classList.remove("active"));
    const btn = document.querySelector(`.center button[onclick="showPage('${id}')"]`);
    if(btn) btn.classList.add("active");
  };

  // --- TOASTS ---
  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // --- DASHBOARD ---
  function updateDashboard() {
    document.getElementById('stat-total').textContent = tasks.length;
    document.getElementById('stat-members').textContent = members.length;
    const pending = tasks.filter(t => t.status !== 'Completed').length;
    document.getElementById('stat-pending').textContent = pending;
  }

  // --- HELPER: GET AVATAR URL ---
  // Returns either the custom base64 image OR a generic placeholder
  function getAvatar(memberObj) {
    if (memberObj.image) return memberObj.image;
    // UPDATED: Using a generic placeholder icon instead of notion-style
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(memberObj.name)}&background=random&color=fff&size=128&bold=true`;
  }

  // --- KANBAN LOGIC ---
  function renderTasks(filterText = "") {
    ['list-todo', 'list-progress', 'list-done'].forEach(id => document.getElementById(id).innerHTML = "");

    let counts = { 'Not Started': 0, 'In Progress': 0, 'Completed': 0 };

    const filtered = tasks.filter(t => {
      const term = filterText.toLowerCase();
      const matchesSearch = t.name.toLowerCase().includes(term) || t.assigned.toLowerCase().includes(term);
      const matchesMember = activeMemberFilter ? t.assigned === activeMemberFilter : true;
      return matchesSearch && matchesMember;
    });

    filtered.forEach(t => {
      counts[t.status]++;
      const card = createTaskCard(t);
      if(t.status === 'Not Started') document.getElementById('list-todo').appendChild(card);
      else if(t.status === 'In Progress') document.getElementById('list-progress').appendChild(card);
      else if(t.status === 'Completed') document.getElementById('list-done').appendChild(card);
    });

    document.getElementById('count-todo').textContent = counts['Not Started'];
    document.getElementById('count-progress').textContent = counts['In Progress'];
    document.getElementById('count-done').textContent = counts['Completed'];

    updateDashboard();
  }

  function createTaskCard(t) {
    const div = document.createElement('div');
    div.className = 'kanban-task';
    div.draggable = true;
    div.ondragstart = (e) => drag(e, t.id);
    div.onclick = () => loadTaskForEdit(t);

    const today = new Date(); today.setHours(0,0,0,0);
    let dateStatus = null;
    if(t.deadline && t.status !== 'Completed') {
       const d = new Date(t.deadline); d.setHours(0,0,0,0);
       if(d < today) dateStatus = 'dot-overdue';
       else if(d.getTime() === today.getTime()) dateStatus = 'dot-today';
    }
    let dotHtml = dateStatus ? `<div class="deadline-indicator ${dateStatus}"></div>` : '';
    
    // Get member object to find correct avatar
    const assignee = members.find(m => m.name === t.assigned);
    // Use generic fallback if not found or no image
    const avatarUrl = assignee ? getAvatar(assignee) : `https://ui-avatars.com/api/?name=${encodeURIComponent(t.assigned)}&background=random&color=fff&size=128&bold=true`;

    div.innerHTML = `
      ${dotHtml}
      <div class="task-title">${t.name}</div>
      <div class="task-footer">
        <span class="priority-badge badge-${t.priority.toLowerCase()}">${t.priority}</span>
        <div class="task-assignee">
           <img src="${avatarUrl}" class="mini-avatar"> ${t.assigned}
        </div>
      </div>
    `;
    return div;
  }

  window.allowDrop = (ev) => ev.preventDefault();
  window.drag = (ev, id) => ev.dataTransfer.setData("text", id);
  window.drop = (ev, newStatus) => {
    ev.preventDefault();
    const id = parseInt(ev.dataTransfer.getData("text"));
    const task = tasks.find(t => t.id === id);
    if(task) {
      const oldStatus = task.status;
      task.status = newStatus;
      saveData();
      renderTasks();
      if(newStatus === 'Completed' && oldStatus !== 'Completed') {
        showToast(`Task Completed! ðŸŽ‰`);
        fireConfetti();
      } else {
        showToast(`Moved to ${newStatus}`);
      }
    }
  }

  // --- CONFETTI ---
  function fireConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let particles = [];
    const colors = ['#b1121f', '#ff4d5e', '#ffd700', '#22863a', '#00bfff'];
    for(let i=0; i<100; i++) {
      particles.push({
        x: Math.random() * canvas.width, y: -10, r: Math.random() * 6 + 2, d: Math.random() * 20 + 10,
        color: colors[Math.floor(Math.random() * colors.length)], tilt: Math.floor(Math.random() * 10) - 10,
        tiltAngleIncremental: (Math.random() * 0.07) + 0.05, tiltAngle: 0
      });
    }
    let angle = 0;
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      angle += 0.01;
      for(let i = 0; i < particles.length; i++) {
        let p = particles[i];
        ctx.beginPath(); ctx.lineWidth = p.r / 2; ctx.strokeStyle = p.color;
        ctx.moveTo(p.x + p.tilt + (p.r / 4), p.y); ctx.lineTo(p.x + p.tilt, p.y + p.tilt + (p.r / 4)); ctx.stroke();
        p.y += (Math.cos(angle + p.d) + 1 + p.r / 2) / 2; p.x += Math.sin(angle); p.tilt = Math.sin(p.tiltAngle - (i / 3)) * 15;
      }
      particles = particles.filter(p => p.y < canvas.height);
      if(particles.length > 0) requestAnimationFrame(draw); else ctx.clearRect(0,0,canvas.width,canvas.height);
    }
    draw();
  }

  // --- TASK ACTIONS ---
  window.saveTask = () => {
    if (!taskNameInput.value) return showToast("Enter a task title", "error");

    if(editingId) {
      const task = tasks.find(t => t.id === editingId);
      if(task) {
        task.name = taskNameInput.value;
        task.deadline = taskDeadlineInput.value;
        task.priority = taskPrioritySelect.value;
        task.assigned = taskMemberSelect.value;
        task.status = taskStatusSelect.value;
        showToast("Task updated!");
      }
      editingId = null;
      cancelEditBtn.style.display = 'none';
      saveTaskBtn.textContent = 'Create Task';
    } else {
      const newTask = {
        id: Date.now(),
        name: taskNameInput.value,
        deadline: taskDeadlineInput.value,
        priority: taskPrioritySelect.value,
        assigned: taskMemberSelect.value,
        status: taskStatusSelect.value
      };
      tasks.push(newTask);
      showToast("Task created!");
    }
    saveData(); resetForm(); renderTasks();
  };

  function loadTaskForEdit(task) {
    editingId = task.id;
    taskNameInput.value = task.name;
    taskDeadlineInput.value = task.deadline;
    taskPrioritySelect.value = task.priority;
    taskMemberSelect.value = task.assigned;
    taskStatusSelect.value = task.status;
    saveTaskBtn.textContent = 'Update Task';
    cancelEditBtn.style.display = 'inline-block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.cancelEdit = () => {
    editingId = null; resetForm();
    saveTaskBtn.textContent = 'Create Task'; cancelEditBtn.style.display = 'none';
  };

  function resetForm() {
    taskNameInput.value = ""; taskDeadlineInput.value = "";
    taskPrioritySelect.value = "Medium"; taskStatusSelect.value = "Not Started";
  }

  // --- MEMBER ACTIONS ---
  window.addMember = () => {
    const name = document.getElementById("memberName").value.trim();
    const role = document.getElementById("memberRole").value.trim() || "Member";
    if (!name) return showToast("Enter a name", "error");
    members.push({ name, role, image: null });
    saveData();
    document.getElementById("memberName").value = "";
    document.getElementById("memberRole").value = "";
    renderMembers();
    showToast("Member added!");
  };

  function renderMembers(filterText = "") {
    const container = document.getElementById("memberCards");
    container.innerHTML = ""; 
    taskMemberSelect.innerHTML = "";
    
    // Filter logic for search
    const filteredMembers = members.filter(m => m.name.toLowerCase().includes(filterText.toLowerCase()) || m.role.toLowerCase().includes(filterText.toLowerCase()));

    // Populate dropdown (always full list)
    members.forEach(m => {
      const opt = document.createElement("option"); opt.value = m.name; opt.textContent = m.name; taskMemberSelect.appendChild(opt);
    });

    // Render Cards
    filteredMembers.forEach(m => {
      const card = document.createElement("div"); card.className = "glass member-card";
      if(activeMemberFilter === m.name) card.classList.add('member-filter-active');
      
      // Card click filters tasks
      card.onclick = (e) => {
        // Prevent click if clicking upload overlay
        if(e.target.closest('.upload-overlay')) return;
        toggleMemberFilter(m.name);
      };

      const avatarSrc = getAvatar(m);
      
      card.innerHTML = `
        <div class="member-avatar-container">
           <img src="${avatarSrc}" class="member-avatar">
           <div class="upload-overlay" onclick="triggerUpload('${m.name}')">ðŸ“·</div>
        </div>
        <h3>${m.name}</h3>
        <p class="role">${m.role}</p>
      `;
      container.appendChild(card);
    });
    updateDashboard();
  }

  // --- AVATAR UPLOAD LOGIC ---
  window.triggerUpload = (memberName) => {
    memberToUploadFor = memberName;
    avatarUploadInput.click();
  };

  avatarUploadInput.addEventListener('change', function() {
    if (this.files && this.files[0] && memberToUploadFor) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const base64Image = e.target.result;
        // Update member
        const member = members.find(m => m.name === memberToUploadFor);
        if(member) {
          member.image = base64Image;
          saveData();
          renderMembers();
          renderTasks(); // Update mini avatars on task cards too
          showToast("Avatar updated!");
        }
        memberToUploadFor = null;
        avatarUploadInput.value = ''; // Reset input
      };
      reader.readAsDataURL(this.files[0]);
    }
  });


  window.toggleMemberFilter = (name) => {
    if(activeMemberFilter === name) {
      activeMemberFilter = null; document.getElementById('clearFilterBtn').style.display = 'none';
    } else {
      activeMemberFilter = name; document.getElementById('clearFilterBtn').style.display = 'block';
      showPage('tasks'); showToast(`Filtering by ${name}`);
    }
    renderMembers(); renderTasks();
  };

  window.clearMemberFilter = () => {
    activeMemberFilter = null; document.getElementById('clearFilterBtn').style.display = 'none';
    renderMembers(); renderTasks();
  };

  // --- DATA ---
  window.exportData = () => {
    const data = { members, tasks };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `taskwise_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click(); showToast("Data exported!");
  };

  window.importData = (input) => {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if(data.members && data.tasks) {
          members = data.members; tasks = data.tasks;
          saveData(); location.reload();
        } else showToast("Invalid backup file", "error");
      } catch(err) { showToast("Error reading file", "error"); }
    };
    reader.readAsText(file);
  };

  function saveData() { localStorage.setItem('tw_members', JSON.stringify(members)); localStorage.setItem('tw_tasks', JSON.stringify(tasks)); }
  window.clearData = () => { if(confirm("Erase all data?")) { localStorage.clear(); location.reload(); } };
  
  // --- FIXED SEARCH ---
  window.handleSearch = () => {
    const term = searchInput.value;
    renderTasks(term);
    renderMembers(term);
  };

  renderMembers(); renderTasks();
});
</script>
</body>
</html>
